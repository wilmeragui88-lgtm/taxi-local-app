<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taxiton Pro</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body{margin:0;font-family:Arial;background:#0f172a;color:white}
h2{margin:10px 0}
.container{padding:20px}
input,button{
width:100%;
padding:12px;
margin:8px 0;
border-radius:8px;
border:none;
font-size:16px
}
button{
background:#22c55e;
color:white;
font-weight:bold;
cursor:pointer
}
button:hover{opacity:0.8}
#map{height:70vh}
.card{
position:fixed;
bottom:0;
left:0;
right:0;
background:white;
color:black;
padding:15px;
border-radius:20px 20px 0 0;
box-shadow:0 -5px 20px rgba(0,0,0,0.3)
}
.hidden{display:none}
.topbar{
background:#111827;
padding:10px;
text-align:center;
font-weight:bold
}
.logout{
position:absolute;
right:10px;
top:10px;
background:red;
padding:5px 10px;
border-radius:6px;
font-size:12px
}
</style>
</head>
<body>

<div class="topbar">
游뚰 TAXITON PRO
<button class="logout" onclick="logout()">Salir</button>
</div>

<!-- LOGIN -->
<div id="login" class="container">
<h2>Iniciar Sesi칩n</h2>
<input type="email" id="email" placeholder="Correo">
<input type="password" id="password" placeholder="Contrase침a">
<button onclick="login()">Entrar</button>
</div>

<!-- SELECCI칍N ROL -->
<div id="role" class="container hidden">
<h2>Selecciona tu rol</h2>
<button onclick="selectRole('cliente')">Soy Cliente</button>
<button onclick="selectRole('taxi')">Soy Taxi</button>
</div>

<!-- MAPA -->
<div id="mapScreen" class="hidden">
<div id="map"></div>

<div class="card">
<h3 id="status">Esperando acci칩n...</h3>
<p id="taxiCount"></p>
<div id="tripInfo"></div>
<button onclick="requestTaxi()">Solicitar Taxi</button>
</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
getAuth, signInWithEmailAndPassword, signOut 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { 
getFirestore, doc, setDoc, onSnapshot, collection 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyCw7WoC5AjqnZ2_vagJs5ZklOZt3b4ZRtg",
authDomain: "taxiton-eba22.firebaseapp.com",
projectId: "taxiton-eba22",
storageBucket: "taxiton-eba22.appspot.com",
messagingSenderId: "1091576841981",
appId: "1:1091576841981:web:1dd7bbefb518580fb76094"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let map;
let userMarker;
let roleSelected;
let userLocation;

// LOGIN
window.login = async () => {
try{
const email=document.getElementById("email").value;
const password=document.getElementById("password").value;
await signInWithEmailAndPassword(auth,email,password);
document.getElementById("login").classList.add("hidden");
document.getElementById("role").classList.remove("hidden");
}catch(e){
alert("Error: "+e.message);
}
};

// LOGOUT
window.logout = async ()=>{
await signOut(auth);
location.reload();
};

// SELECCIONAR ROL
window.selectRole = (role)=>{
roleSelected=role;
document.getElementById("role").classList.add("hidden");
document.getElementById("mapScreen").classList.remove("hidden");
initMap();
};

// INICIAR MAPA
function initMap(){
navigator.geolocation.getCurrentPosition(position=>{
userLocation=[
position.coords.latitude,
position.coords.longitude
];

map=L.map('map').setView(userLocation,15);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
maxZoom:19
}).addTo(map);

userMarker=L.marker(userLocation)
.addTo(map)
.bindPopup("Tu ubicaci칩n")
.openPopup();

if(roleSelected==="taxi"){
startTaxiMode();
}else{
listenTaxis();
}
});
}

// MODO TAXI
function startTaxiMode(){
document.getElementById("status").innerText="Modo TAXI activo 游뚰";

navigator.geolocation.watchPosition(async position=>{
let lat=position.coords.latitude;
let lng=position.coords.longitude;

await setDoc(doc(db,"taxis",auth.currentUser.uid),{
lat,lng,available:true
});

});
}

// ESCUCHAR TAXIS
function listenTaxis(){
onSnapshot(collection(db,"taxis"),snapshot=>{
let count=0;
snapshot.forEach(doc=>{
let data=doc.data();
L.marker([data.lat,data.lng])
.addTo(map)
.bindPopup("Taxi Disponible");
count++;
});
document.getElementById("taxiCount").innerText=
"游뚯 Taxis disponibles: "+count;
});
}

// SOLICITAR TAXI
window.requestTaxi = ()=>{
document.getElementById("status").innerText=
"游댍 Buscando taxi cercano...";
};

</script>
</body>
</html>