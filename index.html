<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAXITON PRO - Super App</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Segoe UI', sans-serif; }
        body { background:#f1f5f9; height:100vh; display: flex; flex-direction: column; }
        header { background:#111827; color:white; padding:15px; text-align:center; font-weight:bold; font-size: 1.2rem; }
        
        #map { height: 45vh; width: 100%; }
        .panel { flex: 1; background:white; border-radius:25px 25px 0 0; padding:20px; overflow-y:auto; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); }
        
        /* UI Elements */
        .card { background:#fff; border: 1px solid #e2e8f0; padding:15px; border-radius:12px; margin-bottom:10px; }
        .btn { width: 100%; padding:12px; border:none; border-radius:10px; cursor:pointer; font-weight:bold; transition: 0.3s; margin-top: 10px;}
        .btn-accept { background:#22c55e; color:white; }
        .btn-request { background:#3b82f6; color:white; }
        
        /* Screens */
        .overlay { position:fixed; inset:0; background:#0f172a; z-index:2000; display:flex; flex-direction:column; justify-content:center; align-items:center; color:white; padding:20px; }
        .hidden { display: none !important; }
        input { width: 100%; padding:12px; margin:8px 0; border-radius:8px; border:none; }
    </style>
</head>
<body>

<div id="roleScreen" class="overlay">
    <h2>üöñ TAXITON PRO</h2>
    <p>Selecciona tu rol para iniciar:</p>
    <button class="btn btn-request" onclick="setRole('client')">Soy PASAJERO</button>
    <button class="btn btn-accept" onclick="setRole('driver')">Soy TAXISTA</button>
</div>

<div id="loginScreen" class="overlay hidden">
    <h2 id="loginTitle">Acceso</h2>
    <input type="email" id="email" placeholder="Correo" value="test@test.com">
    <input type="password" id="password" placeholder="Contrase√±a" value="123456">
    <button class="btn btn-accept" onclick="login()">Entrar al Sistema</button>
</div>

<header id="appHeader">üöñ TAXITON PRO</header>
<div id="map"></div>

<div class="panel">
    <div id="statusBadge" style="text-align: center; margin-bottom: 10px; font-weight: bold; color: #3b82f6;"></div>
    <div id="mainContent">
        </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, setDoc, updateDoc, query, where, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCw7WoC5AjqnZ2_vagJs5ZklOZt3b4ZRtg",
        authDomain: "taxiton-eba22.firebaseapp.com",
        projectId: "taxiton-eba22",
        storageBucket: "taxiton-eba22.appspot.com",
        messagingSenderId: "1091576841981",
        appId: "1:1091576841981:web:1dd7bbefb518580fb76094"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let map, userMarker, taxiMarkers = {}, userRole = '', myLocation = null;

    // --- FLUJO DE INICIO ---
    window.setRole = (role) => {
        userRole = role;
        document.getElementById('roleScreen').classList.add('hidden');
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('loginTitle').innerText = role === 'client' ? 'Pasajero' : 'Conductor';
    };

    window.login = async () => {
        try {
            await signInWithEmailAndPassword(auth, document.getElementById("email").value, document.getElementById("password").value);
            document.getElementById("loginScreen").classList.add("hidden");
            initApp();
        } catch (e) { alert("Error de acceso"); }
    };

    function initApp() {
        navigator.geolocation.getCurrentPosition(pos => {
            myLocation = [pos.coords.latitude, pos.coords.longitude];
            map = L.map("map").setView(myLocation, 15);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
            userMarker = L.marker(myLocation).addTo(map).bindPopup("T√∫ est√°s aqu√≠").openPopup();

            if (userRole === 'client') {
                startClientLogic();
            } else {
                startDriverLogic();
            }
        });
    }

    // --- L√ìGICA DEL CLIENTE ---
    function startClientLogic() {
        document.getElementById('appHeader').innerText = "MODO PASAJERO";
        // 1. Ver taxis disponibles
        onSnapshot(collection(db, "taxis"), snapshot => {
            let html = "<h3>Taxis Disponibles</h3>";
            snapshot.forEach(d => {
                const taxi = d.data();
                html += `<div class="card" onclick="requestRide('${d.id}')">
                            üöï Taxi Disponible (Click para pedir)
                         </div>`;
                updateMapMarker(d.id, [taxi.lat, taxi.lng], 'taxi');
            });
            document.getElementById("mainContent").innerHTML = html;
        });
    }

    window.requestRide = async (taxiId) => {
        const rideId = auth.currentUser.uid;
        await setDoc(doc(db, "rides", rideId), {
            passengerId: rideId,
            taxiId: taxiId,
            status: "pendiente",
            lat: myLocation[0],
            lng: myLocation[1]
        });
        listenRideStatus(rideId);
    };

    function listenRideStatus(id) {
        onSnapshot(doc(db, "rides", id), d => {
            const ride = d.data();
            document.getElementById("statusBadge").innerText = "ESTADO: " + ride.status.toUpperCase();
            if(ride.status === 'aceptado') {
                document.getElementById("mainContent").innerHTML = `<div class="card">‚úÖ El taxi va en camino...</div>`;
            }
        });
    }

    // --- L√ìGICA DEL CONDUCTOR ---
    async function startDriverLogic() {
        document.getElementById('appHeader').innerText = "MODO CONDUCTOR";
        const myTaxiId = auth.currentUser.uid;

        // Registrarse como taxi activo
        await setDoc(doc(db, "taxis", myTaxiId), { lat: myLocation[0], lng: myLocation[1], status: 'libre' });

        // Escuchar solicitudes pendientes para este taxi
        const q = query(collection(db, "rides"), where("taxiId", "==", myTaxiId), where("status", "==", "pendiente"));
        onSnapshot(q, snapshot => {
            let html = "<h3>Solicitudes Nuevas</h3>";
            snapshot.forEach(d => {
                const ride = d.data();
                html += `<div class="card">
                            üìç Nuevo viaje solicitado
                            <button class="btn btn-accept" onclick="acceptRide('${d.id}')">ACEPTAR VIAJE</button>
                         </div>`;
            });
            document.getElementById("mainContent").innerHTML = html;
        });
    }

    window.acceptRide = async (rideId) => {
        await updateDoc(doc(db, "rides", rideId), { status: "aceptado" });
        simulateMovement(rideId);
    };

    async function simulateMovement(rideId) {
        const rideRef = doc(db, "rides", rideId);
        const rideSnap = await getDoc(rideRef);
        const dest = [rideSnap.data().lat, rideSnap.data().lng];
        let curr = [...myLocation];

        const timer = setInterval(async () => {
            // Movimiento suave (nos acercamos 15% cada 2 seg)
            curr[0] += (dest[0] - curr[0]) * 0.15;
            curr[1] += (dest[1] - curr[1]) * 0.15;

            // Actualizar ubicaci√≥n en DB para que el cliente la vea
            await updateDoc(doc(db, "taxis", auth.currentUser.uid), { lat: curr[0], lng: curr[1] });
            userMarker.setLatLng(curr); // Mover mi propio marcador

            if (Math.abs(curr[0] - dest[0]) < 0.0001) {
                clearInterval(timer);
                await updateDoc(rideRef, { status: "en_puerta" });
                alert("Has llegado donde el cliente");
            }
        }, 2000);
    }

    // --- UTILIDADES ---
    function updateMapMarker(id, pos, type) {
        if (!taxiMarkers[id]) {
            taxiMarkers[id] = L.marker(pos).addTo(map);
        } else {
            taxiMarkers[id].setLatLng(pos);
        }
    }

</script>
</body>
</html>
