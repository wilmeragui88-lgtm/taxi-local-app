<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Wilstaxtion Pro AI - Final Stable</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #2ecc71; --secondary: #3498db; --dark: #070b14;
            --card-bg: #111827; --danger: #e74c3c; --text: #f8fafc;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--dark); height: 100vh; overflow: hidden; color: var(--text); position: fixed; width: 100%; }

        /* Splash Screen */
        #splash { position: fixed; inset: 0; background: var(--dark); z-index: 30000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .loader { width: 50px; height: 50px; border: 5px solid #1e293b; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Pantalla de Inicio */
        .full-screen { position: fixed; inset: 0; background: var(--dark); z-index: 9000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 30px; }
        .role-btn { flex: 1; padding: 15px; border: 2px solid #1e293b; border-radius: 12px; cursor: pointer; text-align: center; font-weight: bold; background: var(--card-bg); color: white; }
        .role-btn.active { border-color: var(--primary); color: var(--primary); background: rgba(46, 204, 113, 0.1); }
        input { width: 100%; max-width: 300px; padding: 15px; margin: 8px 0; border-radius: 12px; border: 1px solid #1e293b; background: var(--card-bg); color: white; outline: none; }
        .btn-entrar { width: 100%; max-width: 300px; padding: 15px; background: var(--primary); border: none; border-radius: 12px; font-weight: 900; margin-top: 10px; cursor: pointer; }

        /* App Layout */
        .app-panel { display: none; flex-direction: column; height: 100vh; width: 100%; }
        
        /* Contenedor del Mapa */
        #mapContainer { flex: 1; position: relative; background: #000; overflow: hidden; }
        #map { height: 100%; width: 100%; z-index: 1; }
        
        /* Efecto 3D GPS */
        .gps-mode #map { height: 300%; width: 300%; top: -100%; left: -100%; transform: rotateX(45deg); transition: transform 0.5s ease; }
        .gps-mode { perspective: 1000px; }

        /* Menú Acordeón Profesional */
        .menu-wrap { position: absolute; top: 15px; right: 15px; z-index: 2000; }
        .acc-toggle { width: 45px; height: 45px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #333; box-shadow: 0 4px 15px rgba(0,0,0,0.4); cursor: pointer; }
        .acc-body { display: none; background: white; border-radius: 15px; margin-top: 10px; padding: 8px; flex-direction: column; gap: 5px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
        .acc-body.open { display: flex; }
        .opt-btn { border: none; padding: 10px; border-radius: 8px; background: #f8f9fa; font-size: 11px; font-weight: bold; text-align: left; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .opt-btn:hover { background: #e9ecef; }

        /* IA Banner */
        #iaBanner { position: fixed; bottom: 20px; left: 20px; right: 20px; background: rgba(17, 24, 39, 0.9); padding: 15px; border-radius: 15px; border-left: 5px solid var(--primary); z-index: 10000; display: none; color: white; backdrop-filter: blur(5px); }

        /* Status Conductor */
        .status-box { height: 30vh; background: #070b14; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; border-bottom: 1px solid #1e293b; }
        .circle-btn { width: 90px; height: 90px; border-radius: 50%; border: 6px solid #1e293b; display: flex; align-items: center; justify-content: center; font-weight: 900; transition: 0.3s; cursor: pointer; }
        .circle-btn.on { background: var(--primary); color: #000; box-shadow: 0 0 25px var(--primary); }

        /* Alertas y Botones */
        #tripAlert { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; color: #000; padding: 30px; border-radius: 25px; z-index: 20000; display: none; width: 85%; text-align: center; box-shadow: 0 0 100px rgba(0,0,0,0.8); }
        #finishBtn { position: fixed; bottom: 35px; left: 50%; transform: translateX(-50%); z-index: 5000; background: var(--danger); color: white; border: none; padding: 18px 40px; border-radius: 50px; font-weight: bold; display: none; }
        
        .leaflet-routing-container { display: none !important; }
    </style>
</head>
<body>

<div id="splash"><div class="loader"></div></div>

<div id="authScreen" class="full-screen">
    <h2 style="color:var(--primary); font-weight: 900; letter-spacing: 2px; margin-bottom: 20px;">WILSTAXTION</h2>
    <div style="display:flex; gap:10px; width:100%; max-width:300px; margin-bottom:15px;">
        <div class="role-btn active" id="pRole" onclick="setRole('pasajero')">PASAJERO</div>
        <div class="role-btn" id="tRole" onclick="setRole('taxi')">TAXISTA</div>
    </div>
    <div id="loginInputs">
        <input type="text" id="userName" placeholder="Nombre completo">
    </div>
    <button class="btn-entrar" onclick="iniciarSesion()">INGRESAR AHORA</button>
</div>

<div id="iaBanner"><i class="fas fa-robot"></i> <span id="iaText">...</span></div>

<div id="appPanel" class="app-panel">
    <div id="driverStatus" class="status-box" style="display:none;">
        <div class="circle-btn" id="workBtn" onclick="toggleWork()">OFF</div>
        <p id="workLabel" style="margin-top:10px; font-size:12px; font-weight:bold; color:var(--primary);">SISTEMA DESCONECTADO</p>
    </div>

    <div id="mapContainer">
        <div id="map"></div>
        
        <div class="menu-wrap">
            <div class="acc-toggle" onclick="toggleAcc()"><i class="fas fa-layer-group"></i></div>
            <div class="acc-body" id="accMenu">
                <button class="opt-btn" onclick="updateMap('night')"><i class="fas fa-moon"></i> MODO NOCHE</button>
                <button class="opt-btn" onclick="updateMap('day')"><i class="fas fa-sun"></i> MODO DÍA</button>
                <button class="opt-btn" onclick="updateMap('sat')"><i class="fas fa-globe"></i> SATELITAL</button>
                <hr style="opacity:0.1">
                <button class="opt-btn" onclick="toggleViewMode()" id="viewBtn"><i class="fas fa-map"></i> VISTA GPS 2D</button>
            </div>
        </div>
    </div>

    <div id="passengerBottom" style="height:35vh; background:var(--card-bg); padding:20px; display:none;">
        <h3 style="color:var(--primary); margin-bottom:10px; font-size:16px;">Taxis en el área</h3>
        <div id="listContainer"></div>
    </div>
</div>

<div id="tripAlert">
    <h2 style="font-weight:900;">NUEVA SOLICITUD</h2>
    <p id="clientName" style="font-size:22px; color:var(--secondary); margin:20px 0;"></p>
    <button onclick="aceptarViaje()" style="width:100%; padding:18px; background:var(--primary); color:white; border:none; border-radius:15px; font-weight:900; font-size:16px;">ACEPTAR AHORA</button>
</div>

<button id="finishBtn" onclick="finalizarViaje()">FINALIZAR SERVICIO</button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, deleteDoc, collection, onSnapshot, query, where, addDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCw7WoC5AjqnZ2_vagJs5ZklOZt3b4ZRtg",
        authDomain: "taxiton-eba22.firebaseapp.com",
        projectId: "taxiton-eba22",
        storageBucket: "taxiton-eba22.appspot.com",
        messagingSenderId: "1091576841981",
        appId: "1:1091576841981:web:1dd7bbefb518580fb76094"
    };

    const fb = initializeApp(firebaseConfig);
    const auth = getAuth(fb);
    const db = getFirestore(fb);

    let map, mapLayer, userPos, lastPos = null, role = 'pasajero', currentTripId = null, routing = null;
    const tiles = {
        night: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
        day: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        sat: 'https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}'
    };

    window.setRole = (r) => {
        role = r;
        document.getElementById('pRole').classList.toggle('active', r==='pasajero');
        document.getElementById('tRole').classList.toggle('active', r==='taxi');
        document.getElementById('loginInputs').innerHTML = r === 'pasajero' ? 
            '<input type="text" id="userName" placeholder="Nombre completo">' : 
            '<input type="email" id="userMail" placeholder="Email"><input type="password" id="userPass" placeholder="Clave">';
    };

    window.iniciarSesion = async () => {
        if(role === 'pasajero') {
            localStorage.setItem('wil_name', document.getElementById('userName').value);
            await signInAnonymously(auth);
        } else {
            await signInWithEmailAndPassword(auth, document.getElementById('userMail').value, document.getElementById('userPass').value);
        }
        localStorage.setItem('wil_role', role);
    };

    onAuthStateChanged(auth, user => {
        if(user) {
            document.getElementById('authScreen').style.display='none';
            document.getElementById('appPanel').style.display='flex';
            setTimeout(initMap, 500); // Dar tiempo al DOM para cargar
        }
    });

    function initMap() {
        const currentRole = localStorage.getItem('wil_role');
        navigator.geolocation.getCurrentPosition(pos => {
            userPos = [pos.coords.latitude, pos.coords.longitude];
            map = L.map('map', {zoomControl: false, attributionControl: false}).setView(userPos, 16);
            mapLayer = L.tileLayer(tiles.night).addTo(map);

            if(currentRole === 'pasajero') {
                document.getElementById('passengerBottom').style.display='block';
                L.marker(userPos).addTo(map);
                escucharTaxis();
            } else {
                document.getElementById('driverStatus').style.display='flex';
                document.getElementById('mapContainer').classList.add('gps-mode');
                window.marker = L.marker(userPos, {icon: L.divIcon({html:'<i class="fas fa-location-arrow" style="color:var(--primary); font-size:35px; transform:rotate(-45deg);"></i>', className:''})}).addTo(map);
                escucharViajes();
            }
            map.invalidateSize();
        });
    }

    function hablar(msg) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(msg); utterance.lang='es-ES';
        window.speechSynthesis.speak(utterance);
        document.getElementById('iaText').innerText = msg;
        document.getElementById('iaBanner').style.display='block';
        setTimeout(()=> document.getElementById('iaBanner').style.display='none', 6000);
    }

    window.toggleAcc = () => document.getElementById('accMenu').classList.toggle('open');

    window.updateMap = (style) => {
        if(mapLayer) map.removeLayer(mapLayer);
        mapLayer = L.tileLayer(tiles[style]).addTo(map);
        toggleAcc();
    };

    window.toggleViewMode = () => {
        const container = document.getElementById('mapContainer');
        const isGps = container.classList.toggle('gps-mode');
        document.getElementById('viewBtn').innerHTML = isGps ? '<i class="fas fa-map"></i> VISTA GPS 2D' : '<i class="fas fa-cube"></i> VISTA GPS 3D';
        setTimeout(() => map.invalidateSize(), 400);
        toggleAcc();
    };

    window.toggleWork = () => {
        const btn = document.getElementById('workBtn');
        const isOn = btn.classList.toggle('on');
        btn.innerText = isOn ? "ON" : "OFF";
        document.getElementById('workLabel').innerText = isOn ? "SISTEMA EN LÍNEA" : "SISTEMA DESCONECTADO";
        
        if(isOn) {
            hablar("Wilstaxtion activo. Buen turno.");
            navigator.geolocation.watchPosition(p => {
                const c = [p.coords.latitude, p.coords.longitude];
                if(lastPos && document.getElementById('mapContainer').classList.contains('gps-mode')) {
                    const b = (Math.atan2(Math.sin((c[1]-lastPos[1])*Math.PI/180)*Math.cos(c[0]*Math.PI/180), Math.cos(lastPos[0]*Math.PI/180)*Math.sin(c[0]*Math.PI/180)-Math.sin(lastPos[0]*Math.PI/180)*Math.cos(c[0]*Math.PI/180)*Math.cos((c[1]-lastPos[1])*Math.PI/180))*180/Math.PI+360)%360;
                    document.getElementById('map').style.transform = `rotateX(45deg) rotateZ(${-b}deg)`;
                }
                window.marker.setLatLng(c); map.setView(c);
                lastPos = c;
                setDoc(doc(db, "activos", auth.currentUser.uid), {nombre: "Wil", online: true, lat: c[0], lng: c[1]});
            }, null, {enableHighAccuracy: true});
        }
    };

    function escucharTaxis() {
        onSnapshot(collection(db, "activos"), s => {
            const cont = document.getElementById('listContainer'); cont.innerHTML = '';
            s.forEach(d => { if(d.data().online) {
                const card = document.createElement('div');
                card.style = "background:#1f2937; padding:15px; border-radius:12px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;";
                card.innerHTML = `<span><b>${d.data().nombre}</b></span><button onclick="solicitarViaje('${d.id}')" style="background:var(--primary); border:none; padding:10px 15px; border-radius:8px; font-weight:bold;">PEDIR</button>`;
                cont.appendChild(card);
            }});
        });
    }

    window.solicitarViaje = async (id) => {
        hablar("Conectando con Wil.");
        await addDoc(collection(db, "viajes"), {taxiId: id, pasajeroId: auth.currentUser.uid, pasajeroNombre: localStorage.getItem('wil_name'), status: 'pendiente', lat: userPos[0], lng: userPos[1]});
    };

    function escucharViajes() {
        onSnapshot(query(collection(db, "viajes"), where("taxiId", "==", auth.currentUser.uid)), s => {
            s.docChanges().forEach(change => {
                if(change.type === "added" && change.doc.data().status === 'pendiente') {
                    currentTripId = change.doc.id;
                    document.getElementById('clientName').innerText = change.doc.data().pasajeroNombre;
                    document.getElementById('tripAlert').style.display='block';
                    hablar(`Wil, servicio solicitado por ${change.doc.data().pasajeroNombre}.`);
                    
                    // Trazar Ruta
                    if(routing) map.removeControl(routing);
                    routing = L.Routing.control({
                        waypoints: [L.latLng(lastPos[0], lastPos[1]), L.latLng(change.doc.data().lat, change.doc.data().lng)],
                        lineOptions: { styles: [{color: '#3498db', weight: 8, opacity: 0.7}] },
                        createMarker: () => null
                    }).addTo(map);
                }
            });
        });
    }

    window.aceptarViaje = async () => {
        await updateDoc(doc(db, "viajes", currentTripId), {status: 'aceptado'});
        document.getElementById('tripAlert').style.display='none';
        document.getElementById('finishBtn').style.display='block';
        hablar("Ruta iniciada. Ten cuidado.");
    };

    window.finalizarViaje = async () => {
        await deleteDoc(doc(db, "viajes", currentTripId));
        location.reload();
    };
</script>
</body>
</html>
