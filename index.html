<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taxiton Pro Real</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial}
body{background:#f1f5f9;height:100vh;overflow:hidden}
header{background:#111827;color:white;padding:15px;text-align:center;font-weight:bold}
#map{height:40vh}
.panel{height:60vh;background:white;border-radius:25px 25px 0 0;padding:20px;overflow:auto}
.taxi-card{background:#f9fafb;padding:15px;border-radius:15px;margin-bottom:10px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.1)}
.status{margin-top:10px;font-weight:bold}
.login{position:absolute;top:0;left:0;right:0;bottom:0;background:#0f172a;color:white;display:flex;flex-direction:column;justify-content:center;padding:30px;z-index:2000}
input{padding:12px;margin:10px 0;border-radius:10px;border:none}
button{padding:10px 15px;border:none;border-radius:10px;background:#22c55e;color:white;font-weight:bold}
</style>
</head>
<body>

<div id="loginScreen" class="login">
<h2>ðŸš– TAXITON PRO</h2>
<input type="email" id="email" placeholder="Correo">
<input type="password" id="password" placeholder="ContraseÃ±a">
<button onclick="login()">Entrar</button>
</div>

<header>ðŸš– TAXITON PRO</header>
<div id="map"></div>

<div class="panel">
<h3>Taxis cercanos</h3>
<div id="taxiList"></div>
<div class="status" id="rideStatus"></div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, onSnapshot, doc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyCw7WoC5AjqnZ2_vagJs5ZklOZt3b4ZRtg",
authDomain: "taxiton-eba22.firebaseapp.com",
projectId: "taxiton-eba22",
storageBucket: "taxiton-eba22.appspot.com",
messagingSenderId: "1091576841981",
appId: "1:1091576841981:web:1dd7bbefb518580fb76094"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let map;
let userLocation;
let currentRideId = null;

// LOGIN
window.login = async ()=>{
await signInWithEmailAndPassword(auth,
document.getElementById("email").value,
document.getElementById("password").value
);

document.getElementById("loginScreen").style.display="none";
initMap();
};

// MAPA
function initMap(){
navigator.geolocation.getCurrentPosition(position=>{
userLocation=[position.coords.latitude,position.coords.longitude];

map=L.map("map").setView(userLocation,15);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
L.marker(userLocation).addTo(map).bindPopup("Tu ubicaciÃ³n").openPopup();

listenTaxis();
});
}

// ESCUCHAR TAXIS
function listenTaxis(){
onSnapshot(collection(db,"taxis"),snapshot=>{
let taxiArray=[];
snapshot.forEach(doc=>{
let data=doc.data();
let dist=getDistance(userLocation,[data.lat,data.lng]);
taxiArray.push({id:doc.id,lat:data.lat,lng:data.lng,distance:dist});
});
taxiArray.sort((a,b)=>a.distance-b.distance);
renderTaxiList(taxiArray);
});
}

// RENDER LISTA
function renderTaxiList(taxis){
let container=document.getElementById("taxiList");
container.innerHTML="";
taxis.forEach(taxi=>{
let card=document.createElement("div");
card.className="taxi-card";
card.innerHTML=`
<strong>ðŸš• Taxi</strong><br>
Distancia: ${taxi.distance.toFixed(2)} km
`;
card.onclick=()=>requestRide(taxi.id);
container.appendChild(card);
});
}

// CREAR VIAJE REAL
async function requestRide(taxiId){

currentRideId = auth.currentUser.uid;

await setDoc(doc(db,"rides",currentRideId),{
passengerId:auth.currentUser.uid,
taxiId:taxiId,
status:"pendiente",
lat:userLocation[0],
lng:userLocation[1]
});

document.getElementById("rideStatus").innerText="ðŸŸ¡ Solicitud enviada...";

listenRide();
}

// ESCUCHAR ESTADO DEL VIAJE
function listenRide(){
onSnapshot(doc(db,"rides",currentRideId),docSnap=>{
if(docSnap.exists()){
let data=docSnap.data();
document.getElementById("rideStatus").innerText=
"Estado: "+data.status.toUpperCase();
}
});
}

// DISTANCIA
function getDistance(a,b){
let R=6371;
let dLat=(b[0]-a[0])*Math.PI/180;
let dLon=(b[1]-a[1])*Math.PI/180;
let lat1=a[0]*Math.PI/180;
let lat2=b[0]*Math.PI/180;
let x=Math.sin(dLat/2)**2+
Math.sin(dLon/2)**2*Math.cos(lat1)*Math.cos(lat2);
return 2*R*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

</script>
</body>
</html>