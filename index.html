<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Wilstaxtion Gold Edition - Sistema Integral</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #2ecc71; --secondary: #3498db; --dark: #070b14;
            --card-bg: #111827; --danger: #e74c3c; --text: #f8fafc;
        }

        .day-mode {
            --dark: #f3f4f6; --card-bg: #ffffff; --text: #1f2937;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--dark); height: 100vh; overflow: hidden; color: var(--text); position: fixed; width: 100%; transition: 0.5s; }

        /* --- SISTEMA DE PANTALLAS --- */
        .app-screen { display: none; height: 100vh; flex-direction: column; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- NAVEGACIÓN WAZE STYLE --- */
        #map-viewport { flex: 1; position: relative; perspective: 1000px; overflow: hidden; background: #000; }
        .map-layer { 
            height: 350%; width: 350%; position: absolute; top: -125%; left: -125%;
            transform: rotateX(45deg); transition: transform 1.2s cubic-bezier(0.1, 0, 0.2, 1);
        }

        /* --- UI COMPONENTES --- */
        .status-pill {
            padding: 25px; background: var(--card-bg); border-radius: 25px;
            width: 90%; max-width: 350px; margin: 20px auto; text-align: center; 
            border: 3px solid #1e293b; cursor: pointer; transition: 0.3s;
        }
        .status-pill.active { border-color: var(--primary); box-shadow: 0 0 20px rgba(46,204,113,0.4); }

        .btn-floating {
            position: fixed; top: 20px; left: 20px; z-index: 10000;
            background: var(--card-bg); color: var(--primary); padding: 12px 20px;
            border-radius: 50px; border: 2px solid var(--primary); font-weight: bold;
            display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .speed-badge {
            position: absolute; bottom: 30px; left: 20px;
            background: white; color: black; width: 65px; height: 65px;
            border-radius: 50%; border: 4px solid var(--danger);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: 900; z-index: 5000;
        }

        /* --- ALERTAS --- */
        #tripAlert { 
            position: fixed; bottom: 30px; left: 20px; right: 20px; 
            background: white; color: black; padding: 25px; border-radius: 25px; 
            z-index: 20000; display: none; text-align: center; 
            box-shadow: 0 10px 50px rgba(0,0,0,0.5); 
        }

        input { width: 100%; padding: 18px; margin: 10px 0; border-radius: 15px; border: 1px solid #1e293b; background: var(--card-bg); color: var(--text); outline: none; }
        .btn-main { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 15px; font-weight: 900; margin-top: 10px; }
    </style>
</head>
<body class="dark-mode">

    <button id="backToPanel" class="btn-floating" onclick="showView('driverPanel')">
        <i class="fas fa-cog"></i> PANEL
    </button>

    <div id="authScreen" class="app-screen" style="display: flex; justify-content: center; align-items: center; padding: 30px;">
        <div style="width: 100%; max-width: 350px; text-align: center;">
            <h1 style="color:var(--primary); font-size: 40px; margin-bottom: 10px;">WILSTAXTION</h1>
            <p style="margin-bottom: 30px; opacity: 0.7;">Sistema Inteligente de Transporte</p>
            <input type="email" id="email" placeholder="Correo Electrónico">
            <input type="password" id="pass" placeholder="Contraseña">
            <button class="btn-main" onclick="handleLogin()">INICIAR SESIÓN</button>
        </div>
    </div>

    <div id="driverPanel" class="app-screen">
        <div style="padding: 40px 20px; text-align: center;">
            <h2 id="welcomeText" style="color:var(--primary);">Hola, Conductor</h2>
            <p style="margin-bottom: 30px; opacity: 0.6;">Configura tu estado actual</p>
            
            <div id="statusToggle" class="status-pill" onclick="toggleDuty()">
                <i class="fas fa-power-off" style="font-size: 40px; margin-bottom: 15px; color: #4b5563;"></i>
                <h3 id="statusLabel">DESCONECTADO</h3>
            </div>

            <div style="margin-top: 20px; background: var(--card-bg); padding: 20px; border-radius: 20px; border: 1px solid #1e293b;">
                <h4 style="margin-bottom: 10px; color: var(--secondary);">PERFIL DEL VEHÍCULO</h4>
                <input type="text" id="carDesc" placeholder="Modelo del Auto" style="padding: 10px;">
                <input type="text" id="carPlate" placeholder="Número de Placa" style="padding: 10px;">
            </div>
        </div>
    </div>

    <div id="navScreen" class="app-screen">
        <div id="map-viewport">
            <div id="map" class="map-layer"></div>
            <div class="speed-badge"><span id="speedVal">0</span><small>km/h</small></div>
            <button id="finishBtn" onclick="finishService()" style="display:none; position:absolute; bottom:20px; left:20%; width:60%; background:var(--danger); color:white; padding:15px; border-radius:50px; border:none; font-weight:bold; z-index:6000;">FINALIZAR VIAJE</button>
        </div>
    </div>

    <div id="tripAlert">
        <h2 style="color:#333">¡VIAJE DISPONIBLE!</h2>
        <p id="clientName" style="font-size:24px; font-weight:bold; margin:15px 0;"></p>
        <div style="display:flex; gap:10px;">
            <button onclick="processTrip('aceptado')" style="flex:2; padding:20px; background:var(--primary); color:white; border:none; border-radius:15px; font-weight:bold;">ACEPTAR</button>
            <button onclick="processTrip('rechazado')" style="flex:1; padding:20px; background:#ddd; border-radius:15px; border:none;">X</button>
        </div>
    </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, query, where, updateDoc, collection } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCw7WoC5AjqnZ2_vagJs5ZklOZt3b4ZRtg",
        authDomain: "taxiton-eba22.firebaseapp.com",
        projectId: "taxiton-eba22",
        storageBucket: "taxiton-eba22.appspot.com",
        messagingSenderId: "1091576841981",
        appId: "1:1091576841981:web:1dd7bbefb518580fb76094"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let map, marker, isOnline = false, watchId, lastPos = null, inTrip = false;
    let activeTripId = null;

    // --- MANEJO DE VISTAS ---
    window.showView = (id) => {
        document.querySelectorAll('.app-screen').forEach(s => s.style.display = 'none');
        document.getElementById(id).style.display = 'flex';
        document.getElementById('backToPanel').style.display = (id === 'navScreen') ? 'block' : 'none';
        if(id === 'navScreen' && map) setTimeout(() => map.invalidateSize(), 300);
    };

    // --- IA DE VOZ ---
    function hablar(texto) {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(texto);
        msg.lang = 'es-ES';
        window.speechSynthesis.speak(msg);
    }

    // --- MODO NOCTURNO AUTO ---
    function setMapStyle() {
        const hour = new Date().getHours();
        const isNight = hour >= 18 || hour <= 6;
        document.body.classList.toggle('day-mode', !isNight);
        return isNight ? 'dark_all' : 'light_all';
    }

    // --- AUTH ---
    window.handleLogin = async () => {
        const e = document.getElementById('email').value;
        const p = document.getElementById('pass').value;
        try { await signInWithEmailAndPassword(auth, e, p); } catch { hablar("Error de acceso, verifica tus datos."); }
    };

    onAuthStateChanged(auth, user => {
        if(user) {
            document.getElementById('welcomeText').innerText = "Unidad: " + user.email.split('@')[0].toUpperCase();
            hablar("Sistema iniciado. Bienvenido conductor.");
            initMap();
            showView('driverPanel');
            listenForTrips();
        }
    });

    // --- MAPA E INTERPOLACIÓN ---
    function initMap() {
        const style = setMapStyle();
        map = L.map('map', {zoomControl: false, attributionControl: false}).setView([0,0], 18);
        L.tileLayer(`https://{s}.basemaps.cartocdn.com/${style}/{z}/{x}/{y}{r}.png`).addTo(map);
        marker = L.marker([0,0], {icon: L.divIcon({html: '<i class="fas fa-location-arrow" style="color:#2ecc71; font-size:35px; transform:rotate(-45deg);"></i>', className:''})}).addTo(map);
    }

    window.toggleDuty = () => {
        isOnline = !isOnline;
        const pill = document.getElementById('statusToggle');
        const label = document.getElementById('statusLabel');
        
        pill.classList.toggle('active', isOnline);
        label.innerText = isOnline ? "EN LÍNEA - RASTREANDO" : "DESCONECTADO";
        
        if(isOnline) {
            hablar("Estás en línea. El radar está buscando pasajeros.");
            startGPS();
            showView('navScreen');
        } else {
            hablar("Desconectado.");
            stopGPS();
        }
    };

    function startGPS() {
        watchId = navigator.geolocation.watchPosition(p => {
            const pos = [p.coords.latitude, p.coords.longitude];
            document.getElementById('speedVal').innerText = Math.round((p.coords.speed || 0) * 3.6);

            if(lastPos) {
                const heading = p.coords.heading || (Math.atan2(pos[1] - lastPos[1], pos[0] - lastPos[0]) * 180 / Math.PI);
                document.getElementById('map').style.transform = `rotateX(45deg) rotateZ(${-heading}deg)`;
            }

            marker.setLatLng(pos);
            map.panTo(pos, {animate: true, duration: 1.2});
            lastPos = pos;

            setDoc(doc(db, "activos", auth.currentUser.uid), {
                lat: pos[0], lng: pos[1], online: true, busy: inTrip,
                auto: document.getElementById('carDesc').value,
                placa: document.getElementById('carPlate').value,
                nombre: auth.currentUser.email.split('@')[0]
            }, {merge: true});

        }, null, {enableHighAccuracy: true});
    }

    function stopGPS() {
        if(watchId) navigator.geolocation.clearWatch(watchId);
        updateDoc(doc(db, "activos", auth.currentUser.uid), { online: false });
    }

    // --- GESTIÓN DE VIAJES ---
    function listenForTrips() {
        const q = query(collection(db, "viajes"), where("taxiId", "==", auth.currentUser.uid), where("status", "==", "pendiente"));
        onSnapshot(q, snap => {
            snap.forEach(v => {
                activeTripId = v.id;
                document.getElementById('clientName').innerText = v.data().pasajeroNombre;
                document.getElementById('tripAlert').style.display = 'block';
                hablar("Alerta, tienes una solicitud de viaje entrante.");
            });
        });
    }

    window.processTrip = async (s) => {
        document.getElementById('tripAlert').style.display = 'none';
        if(s === 'aceptado') {
            inTrip = true;
            await updateDoc(doc(db, "viajes", activeTripId), { status: 'aceptado' });
            document.getElementById('finishBtn').style.display = 'block';
            hablar("Viaje aceptado. Iniciando ruta.");
        }
    };

    window.finishService = async () => {
        await updateDoc(doc(db, "viajes", activeTripId), { status: 'finalizado' });
        hablar("Servicio completado satisfactoriamente.");
        location.reload();
    };

</script>
</body>
</html>
