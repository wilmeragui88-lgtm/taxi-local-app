<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TAXITON PRO | Conductor</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root { --p: #3b82f6; --s: #22c55e; --d: #0f172a; --bg: #f8fafc; }
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Inter', sans-serif; }
        body, html { height: 100%; background: var(--bg); overflow: hidden; }

        #map { position: absolute; top: 0; width: 100%; height: 40%; z-index: 1; border-bottom: 2px solid #ddd; }
        
        .panel { 
            position: absolute; bottom: 0; width: 100%; height: 60%; 
            background: white; border-radius: 30px 30px 0 0; padding: 20px; 
            z-index: 100; box-shadow: 0 -10px 25px rgba(0,0,0,0.1); overflow-y: auto;
        }

        .btn { width: 100%; padding: 15px; border: none; border-radius: 15px; font-weight: 700; cursor: pointer; margin-top: 10px; font-size: 16px; transition: 0.3s; }
        .btn-p { background: var(--p); color: white; }
        .btn-s { background: var(--s); color: white; }
        .btn-edit { background: #f1f5f9; color: #475569; font-size: 12px; padding: 8px; width: auto; margin: 0; }
        
        .overlay { position: fixed; inset: 0; background: var(--d); z-index: 9999; display: flex; flex-direction: column; padding: 30px; color: white; overflow-y: auto; }
        .hidden { display: none !important; }
        
        input, textarea, select { background: #1e293b; border: 1px solid #334155; padding: 14px; border-radius: 12px; color: white; margin-bottom: 12px; width: 100%; font-size: 14px; }
        
        .profile-card { background: #fff; border: 1px solid #e2e8f0; padding: 15px; border-radius: 20px; margin-bottom: 15px; display: flex; align-items: center; gap: 15px; }
        .profile-img { width: 65px; height: 65px; border-radius: 50%; object-fit: cover; border: 3px solid var(--p); }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { background: #f8fafc; padding: 12px; border-radius: 15px; text-align: center; border: 1px solid #edf2f7; }
        .stat-box small { color: #64748b; display: block; font-size: 10px; text-transform: uppercase; }
        .stat-box b { color: var(--d); font-size: 14px; }
    </style>
</head>
<body>

<div id="setupScreen" class="overlay">
    <h2 style="text-align:center; margin-bottom:10px;">PERFIL DE CONDUCTOR</h2>
    <p style="text-align:center; color:#94a3b8; font-size:12px; margin-bottom:20px;">Completa tu información para empezar a recibir viajes.</p>
    
    <input type="text" id="cName" placeholder="Nombre completo">
    <input type="text" id="cCar" placeholder="Vehículo (Ej: Toyota Corolla 2022)">
    <input type="text" id="cPlate" placeholder="Número de Placa">
    <input type="text" id="cPhoto" placeholder="URL de tu foto (opcional)">
    <textarea id="cBio" placeholder="Experiencia o mensaje para pasajeros..."></textarea>
    
    <input type="email" id="email" placeholder="Correo electrónico">
    <input type="password" id="password" placeholder="Contraseña">
    
    <button class="btn btn-s" onclick="saveDriver()">GUARDAR Y ACTIVAR GPS</button>
</div>

<div id="map"></div>

<div class="panel">
    <div class="profile-card">
        <img src="https://via.placeholder.com/150" id="driverImg" class="profile-img">
        <div style="flex:1">
            <b id="driverTitle" style="font-size: 18px;">Cargando...</b><br>
            <small id="driverCar" style="color:var(--p); font-weight:600;"></small>
        </div>
        <button class="btn btn-edit" onclick="location.reload()">EDITAR</button>
    </div>

    <div class="stats-grid">
        <div class="stat-box"><small>Estado</small><b style="color:var(--s)">EN LÍNEA</b></div>
        <div class="stat-box"><small>Viajes Hoy</small><b>0</b></div>
    </div>

    <div id="mainUI">
        <div style="text-align:center; padding:30px; color:#94a3b8;">
            <p>Buscando solicitudes de viaje en tu zona...</p>
            <div style="margin-top:15px;" class="loader"></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCw7WoC5AjqnZ2_vagJs5ZklOZt3b4ZRtg",
        authDomain: "taxiton-eba22.firebaseapp.com",
        projectId: "taxiton-eba22",
        storageBucket: "taxiton-eba22.appspot.com",
        messagingSenderId: "1091576841981",
        appId: "1:1091576841981:web:1dd7bbefb518580fb76094"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let map, userLoc;

    window.saveDriver = async () => {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        const name = document.getElementById('cName').value;

        if(!email || !pass || !name) return alert("Nombre, correo y clave son obligatorios.");

        try {
            const userCred = await createUserWithEmailAndPassword(auth, email, pass);
            const uid = userCred.user.uid;

            const driverData = {
                name: name,
                car: document.getElementById('cCar').value,
                plate: document.getElementById('cPlate').value,
                photo: document.getElementById('cPhoto').value || "https://via.placeholder.com/150",
                bio: document.getElementById('cBio').value,
                role: 'driver',
                status: 'online'
            };

            await setDoc(doc(db, "users", uid), driverData);
            startDriverApp(driverData);
        } catch (e) {
            try {
                await signInWithEmailAndPassword(auth, email, pass);
                const d = await getDoc(doc(db, "users", auth.currentUser.uid));
                startDriverApp(d.data());
            } catch(err) { alert("Error: " + err.message); }
        }
    };

    function startDriverApp(data) {
        document.getElementById('setupScreen').classList.add('hidden');
        document.getElementById('driverTitle').innerText = data.name;
        document.getElementById('driverCar').innerText = data.car;
        document.getElementById('driverImg').src = data.photo;

        navigator.geolocation.getCurrentPosition(pos => {
            userLoc = [pos.coords.latitude, pos.coords.longitude];
            initMap(userLoc);
            // Hacer al conductor visible para los pasajeros
            setDoc(doc(db, "taxis", auth.currentUser.uid), {
                name: data.name,
                car: data.car,
                lat: userLoc[0],
                lng: userLoc[1],
                status: 'online'
            }, {merge: true});
        }, () => alert("GPS necesario para trabajar."));
    }

    function initMap(coords) {
        if(!map) {
            map = L.map('map', { zoomControl: false }).setView(coords, 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            L.marker(coords).addTo(map).bindPopup("Estás aquí operando");
            setTimeout(() => map.invalidateSize(), 800);
        }
    }
</script>
</body>
</html>
